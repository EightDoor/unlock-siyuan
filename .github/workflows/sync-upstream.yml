name: Sync Upstream

on:
  workflow_dispatch:
    inputs:
      create_tag:
        description: 'Create release tag after sync'
        required: false
        default: true
        type: boolean
      version:
        description: 'Version (e.g. 3.5.1), leave empty to use package.json version'
        required: false
        type: string

env:
  UPSTREAM_REPO: siyuan-note/siyuan
  UPSTREAM_BRANCH: master

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    outputs:
      merge_success: ${{ steps.merge.outputs.success }}
      version: ${{ steps.version.outputs.value }}
      tag: ${{ steps.version.outputs.tag }}
      tag_created: ${{ steps.create_tag.outputs.created }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git 2>/dev/null || true
          git fetch upstream
      
      - name: Get current branch
        id: branch
        run: echo "name=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT
      
      - name: Merge upstream
        id: merge
        run: |
          git checkout ${{ steps.branch.outputs.name }}
          
          if git merge upstream/${{ env.UPSTREAM_BRANCH }} --allow-unrelated-histories --no-edit -m "chore: sync upstream"; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Merge successful"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Merge failed, there may be conflicts"
            exit 1
          fi
      
      - name: Push changes
        if: steps.merge.outputs.success == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.name }}
          echo "âœ… Changes pushed to ${{ steps.branch.outputs.name }}"
      
      - name: Get version
        id: version
        if: inputs.create_tag == true && steps.merge.outputs.success == 'true'
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(cat app/package.json | jq -r '.version')
          fi
          echo "value=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}-release" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Tag: v${VERSION}-release"
      
      - name: Check if tag exists
        id: check_tag
        if: inputs.create_tag == true && steps.merge.outputs.success == 'true'
        run: |
          if git tag -l | grep -q "^v${{ steps.version.outputs.value }}-release$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag v${{ steps.version.outputs.value }}-release already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create and push tag
        id: create_tag
        if: inputs.create_tag == true && steps.merge.outputs.success == 'true' && steps.check_tag.outputs.exists != 'true'
        run: |
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}
          echo "created=true" >> $GITHUB_OUTPUT
          echo "âœ… Tag ${{ steps.version.outputs.tag }} created and pushed"
          echo "ðŸš€ Build workflow will be triggered automatically"
      
      - name: Summary
        run: |
          echo "## ðŸ“‹ Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Upstream | \`${{ env.UPSTREAM_REPO }}/${{ env.UPSTREAM_BRANCH }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Merge | ${{ steps.merge.outputs.success == 'true' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.create_tag }}" == "true" ] && [ "${{ steps.merge.outputs.success }}" == "true" ]; then
            echo "| Version | \`${{ steps.version.outputs.value }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Tag | \`${{ steps.version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.check_tag.outputs.exists }}" == "true" ]; then
              echo "| Tag Status | âš ï¸ Already exists |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Tag Status | âœ… Created |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
