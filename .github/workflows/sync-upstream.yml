name: Sync Upstream

on:
  schedule:
    # æ¯7å¤©æ£€æŸ¥ä¸€æ¬¡ (UTC æ—¶é—´æ¯å‘¨ä¸€ 00:00)
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no new version'
        required: false
        default: 'false'
        type: boolean

env:
  UPSTREAM_REPO: siyuan-note/siyuan
  UPSTREAM_BRANCH: master

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git fetch upstream --tags
      
      - name: Get latest upstream version
        id: upstream
        run: |
          # è·å–ä¸Šæ¸¸æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ tag (vå¼€å¤´çš„)
          LATEST_TAG=$(git ls-remote --tags upstream | grep -oP 'refs/tags/v\K[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1)
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Latest upstream tag: v${LATEST_TAG}"
          
          # æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å·²ç»æœ‰è¿™ä¸ª tag
          if git rev-parse "v${LATEST_TAG}" >/dev/null 2>&1; then
            echo "already_exists=true" >> $GITHUB_OUTPUT
            echo "Tag v${LATEST_TAG} already exists in our repo"
          else
            echo "already_exists=false" >> $GITHUB_OUTPUT
            echo "New version available: v${LATEST_TAG}"
          fi
      
      - name: Check if sync needed
        id: check
        run: |
          if [ "${{ steps.upstream.outputs.already_exists }}" == "false" ] || [ "${{ inputs.force_sync }}" == "true" ]; then
            echo "sync_needed=true" >> $GITHUB_OUTPUT
          else
            echo "sync_needed=false" >> $GITHUB_OUTPUT
            echo "No sync needed - already up to date"
          fi
      
      - name: Sync from upstream
        if: steps.check.outputs.sync_needed == 'true'
        run: |
          LATEST_TAG="${{ steps.upstream.outputs.latest_tag }}"
          
          echo "ğŸ“¦ Syncing from upstream v${LATEST_TAG}..."
          
          # è·å–ä¸Šæ¸¸ tag å¯¹åº”çš„ commit
          UPSTREAM_COMMIT=$(git rev-parse upstream/v${LATEST_TAG})
          echo "Upstream commit: ${UPSTREAM_COMMIT}"
          
          # åˆ›å»ºåŒæ­¥åˆ†æ”¯
          git checkout -b sync/v${LATEST_TAG}
          
          # åˆå¹¶ä¸Šæ¸¸ä»£ç 
          git merge upstream/v${LATEST_TAG} --no-edit -m "chore: sync upstream v${LATEST_TAG}"
          
          echo "âœ… Merge completed"
      
      - name: Apply patches
        if: steps.check.outputs.sync_needed == 'true'
        run: |
          echo "ğŸ©¹ Applying custom patches..."
          
          # åº”ç”¨æ‰€æœ‰è¡¥ä¸
          for patch in .patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying: $patch"
              if git apply --check "$patch" 2>/dev/null; then
                git apply "$patch"
                echo "âœ“ Applied: $(basename $patch)"
              else
                echo "âš  Patch may have conflicts: $(basename $patch)"
                echo "Attempting to apply with 3-way merge..."
                git apply --3way "$patch" || echo "âŒ Failed to apply: $(basename $patch)"
              fi
            fi
          done
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore: apply custom patches" || echo "No changes to commit"
          fi
      
      - name: Verify VIP bypass
        if: steps.check.outputs.sync_needed == 'true'
        run: |
          echo "ğŸ” Verifying VIP bypass..."
          
          # æ£€æŸ¥ IsSubscriber å‡½æ•°
          if grep -q "return true" kernel/model/conf.go; then
            echo "âœ… VIP bypass verified"
          else
            echo "âŒ VIP bypass not found! Manual intervention required."
            exit 1
          fi
      
      - name: Create tag and push
        if: steps.check.outputs.sync_needed == 'true'
        run: |
          LATEST_TAG="${{ steps.upstream.outputs.latest_tag }}"
          
          # åˆ›å»º tag
          git tag -a "v${LATEST_TAG}" -m "Release v${LATEST_TAG} - Synced from upstream"
          
          # æ¨é€åˆ†æ”¯å’Œ tag
          git push origin sync/v${LATEST_TAG} || true
          git push origin v${LATEST_TAG}
          
          echo "âœ… Created and pushed tag v${LATEST_TAG}"
      
      - name: Create Pull Request
        if: steps.check.outputs.sync_needed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          branch: sync/v${{ steps.upstream.outputs.latest_tag }}
          title: "ğŸ”„ Sync upstream v${{ steps.upstream.outputs.latest_tag }}"
          body: |
            ## ğŸ”„ Upstream Sync
            
            This PR syncs the latest changes from [siyuan-note/siyuan](https://github.com/siyuan-note/siyuan).
            
            ### Version
            Upstream version: **v${{ steps.upstream.outputs.latest_tag }}**
            
            ### Changes
            - Synced from upstream
            - Applied custom patches (VIP bypass, disable auto-update)
            
            ### Checklist
            - [ ] Verify patches applied correctly
            - [ ] Test build locally
            - [ ] Review any conflicts
          labels: sync, automated
          draft: false
      
      - name: Summary
        run: |
          echo "## ğŸ“‹ Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check.outputs.sync_needed }}" == "true" ]; then
            echo "âœ… **New version detected and synced!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Upstream version**: v${{ steps.upstream.outputs.latest_tag }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Pull Request**: Created for review" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag**: v${{ steps.upstream.outputs.latest_tag }} created" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Already up to date**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Current version matches upstream: v${{ steps.upstream.outputs.latest_tag }}" >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    needs: check-and-sync
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Send notification on new version
        if: needs.check-and-sync.outputs.sync_needed == 'true'
        run: |
          echo "ğŸ“¢ New version synced! Check the Pull Request for review."
          # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œå¦‚å‘é€åˆ° Slack/Discord/Email
